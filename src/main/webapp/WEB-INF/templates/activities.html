<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Activity List</title>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/favicon.ico}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }
        .alert-success {
            background-color: #28a745;
            color: white;
        }
        .alert-warning {
            background-color: #ffc107;
            color: white;
        }
        .alert-danger {
            background-color: #dc3545;
            color: white;
        }
        .update-button {
            margin-bottom: 20px;
        }
        .update-button button {
            padding: 10px 20px;
            background-color: #281fc9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a th:href="@{/events}">Sự kiện</a>
        <a th:href="@{/register}">Đăng ký</a>
        <a th:href="@{#}">Danh sách hoạt động</a>
        <a th:href="@{/summary}">Tổng hợp</a>
    </div>
    <div class="main-content"  th:unless="${#lists.isEmpty(allActivities)}">
        <div class="container">
            <h1>Danh Sách Hoạt Động</h1>
            <div class="update-button">
                <button id="update-activities" onclick="updateActivities()">
                    <i class="fas fa-sync-alt"></i> Sync
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>VĐV</th>
                        <th>Hoạt động</th>
                        <th>Quãng đường</th>
                        <th>Tổng thời gian</th>
                        <th>Pace</th>
                        <th>Ngày hoạt động</th>
                    </tr>
                </thead>
                <tbody id="athleteTableBody" th:unless="${#lists.isEmpty(allActivities)}">
                    <tr th:if="${#lists.isEmpty(allActivities)}">
                        <td colspan="6" style="text-align: center;">Không có hoạt động nào</td>
                    </tr>

                    <tr th:each="activity : ${allActivities}" >
                            <td th:text="${activity.getAthleteName()}"></td>
                            <td th:text="${activity.getActivityName()}"></td>
                            <td th:text="${activity.formatDistance()}"></td>
                            <td th:text="${activity.formatMovingTime()}"></td>
                            <td th:text="${activity.getPaced()}"></td>
                            <td th:text="${activity.formatStartDate()}"></td>
                            <td><a th:href="@{https://www.strava.com/activities/{id}(id=${activity.getActivityID()})}" target="blank">View On Strava</a></td>
                            <td onmouseover="showLapDetails(this)" onmouseout="hideLapDetails()" th:attr="activity-id=${activity.getActivityID()}">
                            </td>
                        </tr>
                </tbody>    
            </table>
        </div>
    <div class="footer-left">
        <a href="https://www.strava.com" style="color: #005f73; text-decoration: none; display: flex; align-items: center;">
            <img th:src="@{/images/api_logo_pwrdBy_strava_horiz_white.png}" width=50% height=50%/>
        </a>
    </div>
        <div class="footer-right">Developed by ERP</div>
    </div>
    <script th:inline="javascript">
        updateActivities = function() {
            const button = document.getElementById("update-activities");
            const originalContent = button.innerHTML;
             // Change the button content to a loading spinner
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sync`;
            button.disabled = true; // Disable the button to prevent multiple clicks
            const tbody = document.getElementById("athleteTableBody");
            const athleteId = getUrlParam("athleteId");
            var endpoint = '/runner/activities/update';
            if (athleteId != null) {
                endpoint += '?athleteId=' + athleteId; 
            }
            fetch(endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
            })
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = ""; 
                data.forEach(activity => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${activity.athleteName}</td>
                        <td>${activity.activityName}</td>
                        <td>${activity.distance}</td>
                        <td>${activity.movingTime}</td>
                        <td>${activity.paced}</td>
                        <td>${activity.startDateLocal}</td>
                        <td><a href="https://www.strava.com/activities/${activity.activityId}" target="blank">View On Strava</a></td>
                    `;
                    tbody.appendChild(row);
                });
                if (data && data.length > 0) {
                    showAlert("Cập nhật hoạt động thành công", "success");
                } else {
                    showAlert("Không có hoạt động nào để cập nhật", "warning");
                }
            })
            .catch(error => console.error("Error updating activities:", error))
            .finally(() => {
                button.innerHTML = originalContent; // Restore the original content
                button.disabled = false; // Re-enable the button
            });
        }
        function showLapDetails(row) {
            const activityId = row.getAttribute("activity-id");

            // Check if a lap details row already exists and remove it
            const existingLapRow = document.getElementById("lap-details-row");
            if (existingLapRow) {
                existingLapRow.remove();
            }

            // Create a new row for lap details
            const lapDetailsRow = document.createElement("tr");
            lapDetailsRow.id = "lap-details-row";
            const lapDetailsCell = document.createElement("td");
            lapDetailsCell.colSpan = 7; // Span across all columns
            lapDetailsCell.style.backgroundColor = "#f9f9f9";
            lapDetailsCell.style.border = "1px solid #ccc";
            lapDetailsCell.style.padding = "10px";
            lapDetailsRow.appendChild(lapDetailsCell);

            // Insert the lap details row after the current row
            row.parentNode.insertBefore(lapDetailsRow, row.nextSibling);

            // Fetch lap details
            fetch(`/runner/activities/laps?activityId=${activityId}`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.length > 0) {
                    lapDetailsCell.innerHTML = `
                        <h4>Lap Details</h4>
                        <ul>
                            ${data.map(lap => `<li>Lap ${lap.lapIndex}: ${lap.distance} km in ${lap.movingTime} mins</li>`).join("")}
                        </ul>
                    `;
                } else {
                    lapDetailsCell.innerHTML = `<p>Không có thông tin Lap</p>`;
                }
            })
            .catch(error => {
                lapDetailsCell.innerHTML = `<p>Error fetching lap details</p>`;
                console.error("Error fetching lap details:", error);
            });
        }

        function hideLapDetails() {
            // Remove the lap details row when the mouse leaves the activity row
            const lapDetailsRow = document.getElementById("lap-details-row");
            if (lapDetailsRow) {
                lapDetailsRow.remove();
            }
        }
        showAlert = function(message, type) {
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerText = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        function getUrlParam(paramName) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(paramName);
        }
    </script>
</body>
</html>
